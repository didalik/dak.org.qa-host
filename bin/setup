#!/bin/bash

# Copyright (c) 2023-present, Дід Alik and the Kids {{{1
##

add_account () { # {{{1
  local user=$1 userdesc=$2
  [ -d /home/$user ] && return

  err "+ add_account started on $(date) $user $userdesc"
  sudo useradd -md /home/$user -c "$userdesc" -s /bin/bash -k $user -U $user
  sudo -u $user chmod -R 600 /home/$user/.ssh
}

apply () { # {{{1
  local msg="+ apply $1 started on $(date)"
  err "$msg"
  local qa_desc="$(git config -f $1 --get qa.desc)"
  local relay_desc="$(git config -f $1 --get relay.desc)"
  local tester_desc="$(git config -f $1 --get tester.desc)"
  local kt="$(git config -f $1 --get kot.tophub)"
  local ta="$(git config -f $1 --get tophub.account)"

  add_account qa "$qa_desc"
  add_account tester "$tester_desc"

  cd relay/.ssh; base64 -d id_ed25519.base64 > id_ed25519; cd -
  add_account relay "$relay_desc"
  rm relay/.ssh/id_ed25519
  sudo -u relay ssh "ta@$kt" "echo '$0 $msg' > index"
  sudo userdel -r relay
}
configure () { # {{{1
  [ -e "$1" ] && return

  err "+ configure $1 started on $(date)" # {{{2
  local green=$(git config --get-color color.diff.whitespace "green")
  local reset=$(git config --get-color "" "reset") # }}}2
  cat > $1 << HD
## This is the config file $1. {{{2
#
# Usage example:
#
#   ${green}git config -f $1 --get kot.tophub${reset}
#
# See also: ${green}git config --help${reset}

; ${green}Local accounts${reset} {{{2
[qa]
  desc = 'QA box owner'
[relay]
  desc = 'Connects to tophub and dies'
[tester]
  desc = 'The tester role'

; ${green}Kloud Of Trust${reset} {{{2
[kot]
  tophub = 127.0.0.1 ;159.250.189.50
[tophub]
  account = guest

; }}}2
HD
  cat $1
}

err () { # {{{1
  local red=$(git config --get-color color.diff.whitespace "red")
  local reset=$(git config --get-color "" "reset")
  echo "${red}$@${reset}" >&2
}

setup_qa_hub () { # {{{1
  err "+ $0 started on $(date)"
  configure setup.config
  apply setup.config
}

setup_qa_hub
